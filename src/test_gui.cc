#include "linemixing.h"
#include "predefined_absorption_models.h"
#include "gui/plot.h"
#include "auto_md.h"
#include "physics_funcs.h"
#include "lineshape.h"

Vector VectorNLinSpaceConst(Numeric f0, Numeric f1, Index n) {
  Vector x;
  VectorNLinSpace(x, n, f0, f1, Verbosity{});
  return x;
}

Vector VectorNLogSpaceConst(Numeric f0, Numeric f1, Index n) {
  Vector x;
  VectorNLogSpace(x, n, f0, f1, Verbosity{});
  return x;
}
  
int main() {
  std::stringstream ss("47929387875.2229 3.76825765434629e-25 6.39288315401667e-20 93 95 4.417e-10 0.00100339716312057 -0.0425337497440969 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 46 47 47 47 \n"
                       "48435909117.8633 1.3274749386654e-24 5.86939467999304e-20 89 91 4.56e-10 0.00108313429951691 -0.0444288681399483 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 44 45 45 45 \n"
                       "48943503017.9185 4.42190426585161e-24 5.36779723660436e-20 85 87 4.705e-10 0.00117412262156448 -0.0465002101505717 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 42 43 43 43 \n"
                       "49452303882.4095 1.39253838017929e-23 4.88817326135371e-20 81 83 4.853e-10 0.00127858304297329 -0.0487735502345263 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 40 41 41 41 \n"
                       "49962471500.7166 4.14478220014428e-23 4.43060102020786e-20 77 79 5.005e-10 0.00139931282051282 -0.0512799458407427 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 38 39 39 39 \n"
                       "50474199538.7676 1.16541877415394e-22 3.99515520353102e-20 73 75 5.16e-10 0.00153987482219061 -0.0540571637755708 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 36 37 37 37 \n"
                       "50987723633.4345 3.09352566827629e-22 3.58190692608491e-20 69 71 5.317e-10 0.00170486349206349 -0.0571515949553766 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 34 35 35 35 \n"
                       "51503336382.1562 7.75339344707223e-22 3.19092372702864e-20 65 67 5.48e-10 0.00190028520499109 -0.0606208643829584 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 32 33 33 33 \n"
                       "52021404431.109 1.83322270858126e-21 2.82226897398507e-20 61 63 5.647e-10 0.00213411290322581 -0.0645374497084855 10059.6531675302 0.72 0 0 0 0.72 0 0 10266.7636739206 0.72 0 0 0 0.72 0 0 30 31 31 31 \n"
                       "52542394856.9423 4.08755046918299e-21 2.47600265761908e-20 57 59 5.82e-10 0.00241711264367816 -0.0689937941931067 10355.5253195164 0.72 0 0 0 0.72 0 0 10296.3508891192 0.72 0 0 0 0.72 0 0 28 29 29 29 \n"
                       "53066912640.8365 8.58174744782781e-21 2.15218139163761e-20 53 55 5.994e-10 0.00276410582010582 -0.0741096869563658 10651.3974715026 0.72 0 0 0 0.72 0 0 10355.5253195164 0.72 0 0 0 0.72 0 0 26 27 27 27 \n"
                       "53595757329.277 1.69616777391079e-20 1.8508572209221e-20 49 51 6.173e-10 0.00319595076923077 -0.0800431763685832 10947.2696234888 0.72 0 0 0 0.72 0 0 10414.6997499136 0.72 0 0 0 0.72 0 0 24 25 25 25 \n"
                       "54130009973.8673 3.15376959560397e-20 1.57207940932982e-20 45 47 6.36e-10 0.00374275362318841 -0.0870071595435633 11243.141775475 0.72 0 0 0 0.72 0 0 10473.8741803109 0.72 0 0 0 0.72 0 0 22 23 23 23 \n"
                       "54671168637.5202 5.50629495774982e-20 1.31589304918172e-20 41 43 6.549e-10 0.00444926406926407 -0.0952954158056413 11539.0139274611 0.72 0 0 0 0.72 0 0 10533.0486107081 0.72 0 0 0 0.72 0 0 20 21 21 21 \n"
                       "55221376536.5177 9.02152811731986e-20 1.08233925990705e-20 37 39 6.748e-10 0.00538433684210526 -0.105325006369713 11834.8860794473 0.72 0 0 0 0.72 0 0 10947.2696234888 0.72 0 0 0 0.72 0 0 18 19 19 19 \n"
                       "55783810271.745 1.38350179108014e-19 8.71455783977092e-21 33 35 6.953e-10 0.00665837908496732 -0.117708429714795 12130.7582314335 0.72 0 0 0 0.72 0 0 11509.4267122625 0.72 0 0 0 0.72 0 0 16 17 17 17 \n"
                       "56264781402.3599 8.25040584752558e-20 4.14034910005551e-23 5 3 5.844e-10 1.0011 0.970122237409002 16864.7126632124 0.72 0 0 0 0.97 0 0 16864.7126632124 0.72 0 0 0 0.97 0 0 2 1 1 1 \n"
                       "56363396632.4567 1.98112155017071e-19 6.83276589616003e-21 29 31 7.167e-10 0.00845753333333333 -0.133383069062231 12426.6303834197 0.72 0 0 0 0.72 0 0 11953.2349402418 0.72 0 0 0 0.72 0 0 14 15 15 15 \n"
                       "56968211727.679 2.63988889549887e-19 5.1783147351164e-21 25 27 7.394e-10 0.0111158241758242 -0.153858929609147 12722.5025354059 0.72 0 0 0 0.72 0 0 12337.8687378238 0.72 0 0 0 0.72 0 0 12 13 13 13 \n"
                       "57612488204.3553 3.25618427206103e-19 3.75146458104732e-21 21 23 7.637e-10 0.0152824242424242 -0.181732800635926 13018.3746873921 0.72 0 0 0 0.72 0 0 12752.0897506045 0.72 0 0 0 0.72 0 0 10 11 11 11 \n"
                       "58323880417.774 3.68692835245393e-19 2.5524240107678e-21 17 19 7.902e-10 0.0223600888888889 -0.221873181488793 13314.2468393782 0.72 0 0 0 0.72 0 0 13136.7235481865 0.72 0 0 0 0.72 0 0 8 9 9 9 \n"
                       "58446595363.9845 2.2720997191634e-19 3.25530801286138e-22 9 7 7.682e-10 0.166946666666667 0.495924531107892 15385.3519032815 0.72 0 0 0 0.72 0 0 15207.8286120898 0.72 0 0 0 0.72 0 0 4 3 3 3 \n"
                       "59164208870.4916 3.78030643981183e-19 1.58134995350055e-21 13 15 8.21e-10 0.0358654285714286 -0.284561797673629 13610.1189913644 0.72 0 0 0 0.72 0 0 13610.1189913644 0.72 0 0 0 0.72 0 0 6 7 7 7 \n"
                       "59590989816.1909 3.35257455578531e-19 8.38756898722564e-22 13 11 8.339e-10 0.0668482666666667 0.332459702435534 14201.8632953368 0.72 0 0 0 0.72 0 0 14231.4505105354 0.72 0 0 0 0.72 0 0 6 5 5 5 \n"
                       "60306062281.8239 3.41281848311299e-19 8.38282138162705e-22 9 11 8.59e-10 0.0668482666666667 -0.395594131107892 14201.8632953368 0.72 0 0 0 0.72 0 0 14231.4505105354 0.72 0 0 0 0.72 0 0 4 5 5 5 \n"
                       "60434784469.3078 3.9550138290621e-19 1.58050770045712e-21 17 15 8.773e-10 0.0358654285714286 0.249910292599905 13610.1189913644 0.72 0 0 0 0.72 0 0 13610.1189913644 0.72 0 0 0 0.72 0 0 8 7 7 7 \n"
                       "61150568042.6513 4.06044070188553e-19 2.55055079232451e-21 21 19 9.123e-10 0.0223600888888889 0.200164509726835 13314.2468393782 0.72 0 0 0 0.72 0 0 13136.7235481865 0.72 0 0 0 0.72 0 0 10 9 9 9 \n"
                       "61800163137.325 3.75018447614799e-19 3.74868951618489e-21 25 23 9.431e-10 0.0152824242424242 0.166924057814275 13018.3746873921 0.72 0 0 0 0.72 0 0 12752.0897506045 0.72 0 0 0 0.72 0 0 12 11 11 11 \n"
                       "62411224108.6172 3.17184277380228e-19 5.17470933588567e-21 29 27 9.728e-10 0.0111158241758242 0.143148250014612 12722.5025354059 0.72 0 0 0 0.72 0 0 12337.8687378238 0.72 0 0 0 0.72 0 0 14 13 13 13 \n"
                       "62486259462.7225 2.53144982630905e-19 3.22855058716558e-22 5 7 9.147e-10 0.166946666666667 -0.636228904075668 15385.3519032815 0.72 0 0 0 0.72 0 0 15207.8286120898 0.72 0 0 0 0.72 0 0 2 3 3 3 \n"
                       "62997986001.8112 2.4769290720775e-19 6.82836989147816e-21 33 31 1.001e-09 0.00845753333333333 0.125300606185383 12426.6303834197 0.72 0 0 0 0.72 0 0 11953.2349402418 0.72 0 0 0 0.72 0 0 16 15 15 15 \n"
                       "63568526125.1028 1.79798001109457e-19 8.70939903987991e-21 37 35 1.029e-09 0.00665837908496732 0.111410713972052 12130.7582314335 0.72 0 0 0 0.72 0 0 11509.4267122625 0.72 0 0 0 0.72 0 0 18 17 17 17 \n"
                       "64127773066.5015 1.21752977129238e-19 1.08174908684289e-20 41 39 1.057e-09 0.00538433684210526 0.100294006281832 11834.8860794473 0.72 0 0 0 0.72 0 0 10947.2696234888 0.72 0 0 0 0.72 0 0 20 19 19 19 \n"
                       "64678906724.6094 7.71423489430924e-20 1.31522977491002e-20 45 43 1.085e-09 0.00444926406926407 0.091195618041587 11539.0139274611 0.72 0 0 0 0.72 0 0 10533.0486107081 0.72 0 0 0 0.72 0 0 22 21 21 21 \n"
                       "65224071514.8785 4.58155067326995e-20 1.57134442436267e-20 49 47 1.112e-09 0.00374275362318841 0.0836117897019165 11243.141775475 0.72 0 0 0 0.72 0 0 10473.8741803109 0.72 0 0 0 0.72 0 0 24 23 23 23 \n"
                       "65764769397.5234 2.55645105615004e-20 1.85005092254868e-20 53 51 1.141e-09 0.00319595076923077 0.0771934932241721 10947.2696234888 0.72 0 0 0 0.72 0 0 10414.6997499136 0.72 0 0 0 0.72 0 0 26 25 25 25 \n"
                       "66302084422.0722 1.34102982231412e-20 2.15130437579168e-20 57 55 1.169e-09 0.00276410582010582 0.071691272025619 10651.3974715026 0.72 0 0 0 0.72 0 0 10355.5253195164 0.72 0 0 0 0.72 0 0 28 27 27 27 \n"
                       "66836819132.935 6.62080761331187e-21 2.47505552023439e-20 61 59 1.198e-09 0.00241711264367816 0.0669221034719264 10355.5253195164 0.72 0 0 0 0.72 0 0 10296.3508891192 0.72 0 0 0 0.72 0 0 30 29 29 29 \n"
                       "67369583607.7638 3.07846468644437e-21 2.82125191370621e-20 65 63 1.227e-09 0.00213411290322581 0.0627486674132615 10059.6531675302 0.72 0 0 0 0.72 0 0 10266.7636739206 0.72 0 0 0 0.72 0 0 32 31 31 31 \n"
                       "67900848820.5102 1.34976519177664e-21 3.18983714114478e-20 69 67 1.256e-09 0.00190028520499109 0.0590659210057967 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 34 33 33 33 \n"
                       "68430986214.0296 5.58159986690942e-22 3.58075121188522e-20 73 71 1.286e-09 0.00170486349206349 0.0557921427545498 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 36 35 35 35 \n"
                       "68960293782.0252 2.17842041216886e-22 3.99393036101551e-20 77 75 1.316e-09 0.00153987482219061 0.0528628014412826 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 38 37 37 37 \n"
                       "69489013457.0107 8.03051551277955e-23 4.4293072480211e-20 81 79 1.346e-09 0.00139931282051282 0.0502262624296483 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 40 39 39 39 \n"
                       "70017345200.5556 2.79592066727756e-23 4.88681055949571e-20 85 83 1.377e-09 0.00127858304297329 0.0478407195636393 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 42 41 41 41 \n"
                       "70545455997.0589 9.2022598993029e-24 5.36636600236429e-20 89 87 1.409e-09 0.00117412262156448 0.0456719630894432 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 44 43 43 43 \n"
                       "71073487948.1458 2.86339386588456e-24 5.86789471472631e-20 93 91 1.441e-09 0.00108313429951691 0.0436917293925705 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 46 45 45 45 \n"
                       "71601561570.3843 8.42812543314223e-25 6.39131465636786e-20 97 95 1.473e-09 0.00100339716312057 0.0418764629973242 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 48 47 47 47 \n"
                       "72129782990.3046 2.34770584795963e-25 6.93654021147252e-20 101 99 1.506e-09 0.000933129795918367 0.040206375484934 10059.6531675302 0.72 0 0 0 0.72 0 0 10237.1764587219 0.72 0 0 0 0.72 0 0 50 49 49 49 \n"
                       "118750348044.712 3.01219636638393e-19 0 1 3 4.48e-09 1.0011 0 16864.7126632124 0.72 0 0 0 0.97 0 0 16864.7126632124 0.72 0 0 0 0.97 0 0 0 1 1 1");
  
  const SpeciesTag sp("O2-66");
  const QuantumIdentifier qid(sp.Isotopologue(),
                              {QuantumNumberType::S, QuantumNumberType::Lambda, QuantumNumberType::v1, QuantumNumberType::ElectronState},
                              {Rational(1), Rational(0), Rational(0), Rational(88)}, {Rational(1), Rational(0), Rational(0), Rational(88)});
  const LineShape::Model metamodel = LineShape::MetaData2ModelShape("G0 T1 T1 D0 T5 T5");
  AbsorptionLines band(true, true, 49, Absorption::CutoffType::None,
                       Absorption::MirroringType::None, Absorption::PopulationType::ByMakarovFullRelmat,
                       Absorption::NormalizationType::None, LineShape::Type::VP, 296, 750e9, -1, qid, 
                       {QuantumNumberType::J, QuantumNumberType::N}, {Species::Species::Oxygen, Species::Species::Bath}, metamodel);
  ss >> band;
  Index wigner_initialized;
  Wigner6Init(wigner_initialized, 20000000, 250, Verbosity{});
  
  // Initializing values
  constexpr Index nfreq = 100000;
  Vector f_grid = VectorNLinSpaceConst(50e9, 70e9, nfreq);
  const Numeric P=Conversion::atm2pa(0.5);
  const Numeric T=296;
  const Numeric H=50e-6;
  const Vector VMR = {0.21, 0.79};
  Matrix xsec(nfreq, 1, 0);
  ArrayOfMatrix dxsec, dsource, dphase;
  ArrayOfArrayOfSpeciesTag specs(2, ArrayOfSpeciesTag(1));
  specs[0][0] = SpeciesTag("O2");
  specs[1][0] = SpeciesTag("N2");
  Matrix VMRmat(2, 1); VMRmat(0, 0) = VMR[0]; VMRmat(1, 0) = VMR[1];
  Matrix xsec2(nfreq, 1, 0), xsec3(nfreq, 1, 0), source, phase;
  
  // Retrieval Quantities
  RetrievalQuantity rq;
  rq.Target(Jacobian::Target(Jacobian::Atm::Temperature));
  rq.Target().Perturbation(0.1);
  
  // Line Mixing full calculations
  const auto [abs, dabs] = Absorption::LineMixing::ecs_absorption(T, P, 1, VMR, {31.989830, 28.006148}, f_grid, band,
                                                                  {rq});
  
  // Line Mixing full calculations
  ComplexVector absdT = Absorption::LineMixing::ecs_absorption(T+0.1, P, 1, VMR, {31.989830, 28.006148}, f_grid, band).first;
  
  // Line Mixing full calculations with Zeeman (ignoring polarization...)
  auto [absZ, dabsZ] = Absorption::LineMixing::ecs_absorption_zeeman(T, H, P, 1, VMR, {31.989830, 28.006148}, f_grid, 
                                                                     Zeeman::Polarization::Pi, band);
  absZ += Absorption::LineMixing::ecs_absorption_zeeman(T, H, P, 1, VMR, {31.989830, 28.006148}, f_grid, 
                                                        Zeeman::Polarization::SigmaMinus, band).first;
  absZ += Absorption::LineMixing::ecs_absorption_zeeman(T, H, P, 1, VMR, {31.989830, 28.006148}, f_grid, 
                                                        Zeeman::Polarization::SigmaPlus, band).first;
  
  // Line Mixing reimplementation of MPM19
  Absorption::PredefinedModel::makarov2020_o2_lines_mpm(xsec, dxsec,
                                                        f_grid, {P}, {T}, {0},
                                                        ArrayOfRetrievalQuantity(0));
  
  // Line by line calculations
  band.Population(Absorption::PopulationType::LTE);
  xsec_species(xsec2, source, phase, dxsec, dsource, dphase,
               ArrayOfRetrievalQuantity(0),
               f_grid, {P}, {T}, EnergyLevelMap{}, VMRmat, specs, band, 1);
  xsec2 *= number_density(P, T);
  
  band.Population(Absorption::PopulationType::ByMakarovFullRelmat);
//   auto data = Absorption::LineMixing::ecs_eigenvalue_adaptation_test(band,
//     VectorNLinSpaceConst(200, 350, 76), {31.989830, 28.006148},
//     VectorNLogSpaceConst(1, 1'000'000'000'000, 101));
//   WriteXML("ascii", data, "prestemp.xml", 0, "", "", "", Verbosity());
  
  Absorption::LineMixing::ecs_eigenvalue_adaptation(band,
                                                    VectorNLinSpaceConst(200, 350, 76),
                                                    {31.989830, 28.006148},
                                                    Conversion::atm2pa(1), 2);
  LineShape::ComputeData com(f_grid, {rq}, 0);
  LineShape::ComputeData sparse_com(Vector(0), {rq}, 0);
  LineShape::compute(com, sparse_com, band, {rq}, {},
                     band.BroadeningSpeciesVMR(VMR, specs), 1.0, 1.0, P, T, 0, 0,
                     false, Zeeman::Polarization::Pi, Options::LblSpeedup::None);
  
  // Plot it all
  f_grid /= 1e9;  // Rescale for easier axis
  ARTSGUI::PlotConfig::Legend = {"Full", "MPM2020", "LBL", "FullZeeman", "Adapted"};
  ARTSGUI::PlotConfig::X = "Frequency [GHz]";
  ARTSGUI::PlotConfig::Y = "Absorption [1/m]";
  ARTSGUI::plot(f_grid, abs.real(), f_grid, xsec(joker, 0), f_grid, xsec2(joker, 0), f_grid, absZ.real(), f_grid, com.F.real());
}
