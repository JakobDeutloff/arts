\chapter{Transmission calculations}
 \label{sec:trans}


\starthistory
 120921 & A first, but incomplete, version (Patrick Eriksson).\\
\stophistory

The term ``transmission calculations'' refers here to situations when
atmospheric and surface emission can be neglected. These calculations can be
divided into two main types. The first one is when just the transmission of the
atmosphere is diagnosed (Sec.~\ref{sec:transmission}). The observation geometry
is given exactly as for emission simulations, by a position and a
line-of-sight.

The second main type is radio link budgets (Sec.~\ref{sec:rlinks}). For
this case, the propagation path is determined solely by the position of the
transmitter and the receiver. That is, the user does not need to set a
line-of-sight of the sensor (receiver), it is determined by the transmitter
position. A characterisation of a radio link normally involves several
attenuation terms not encountered for passive measurements, such as free space
loss and defocusing. Faraday rotation is an additional physical mechanism that
is of special concern for active microwave devices (it can normally be
neglected at the higher frequencies used for passive observations).




\section{Pure transmission calculations}
%===================
\label{sec:transmission}

This section discusses the \wsmindex{iyTransmissionStandard} workspace method,
that is relevant if you want to calculate the transmission through the
atmosphere for a given position and line-of-sight. The set-up is largely the
same as for simulations involving emission, such as that the observation
geometry is defined by \wsvindex{sensor\_pos} and \wsvindex{sensor\_los} (or
\wsvindex{rte\_pos} and \wsvindex{rte\_los} if \builtindoc{iyCalc} is used).
The first main difference is that \wsaindex{iy\_transmitter\_agenda} replaces
\wsaindex{iy\_space\_agenda} and \wsaindex{iy\_surface\_agenda}. The second
main difference is that handling of cloud scattering is built-in and the need
to define \wsaindex{iy\_cloudbox\_agenda} vanishes. These differences appear
inside \wsaindex{iy\_main\_agenda}. Further,
\builtindoc{blackbody\_radiation\_agenda} can be left undefined).

As for emission measurements (Sec.~\ref{sec:fm_defs:calcproc},
Algorithm~\ref{alg:fm_defs:iyCSagenda}) the first main operation is to
determine the propagation path through the atmosphere, but this is here done
without considering the cloud-box (it is simple deactivated during this step).
The possible ``radiative backgrounds'' are accordingly the surface or space,
i.e.\ where the propagation path starts. 

The next step is to call \builtindoc{iy\_transmitter\_agenda}. It should be
noted that the same agenda is called independently if the radiative background
is space or the surface. It is up to the user to decide if these two cases
shall be distinguished in some manner (no workspace method for this task exists
yet). For these calculations, the standard choice for
\builtindoc{iy\_transmitter\_agenda} is \wsmindex{MatrixUnitIntensity}. If this
workspace method is used, the output of \builtindoc{iyTransmissionStandard}
shows you the fraction of unpolarised radiation that is transmitted through the
atmosphere, and the polarisation state of the transmitted part.

The radiative transfer expression applied is
(cf.~Eq.~\ref{eq:fm_defs:vrte_step})
\begin{equation}
  \label{eq:trans:vrte}
  \StoVec_{i+1} = e^{-\bar{\ExtMat}s} \StoVec_i 
\end{equation}
where the extinction matrix is determined in the same manner as for emission
cases (Sec.~\ref{sec:fm_defs:rad_bkgr}). In situations where the matrix
\ExtMat\ is diagonal, the scalar form shown in Eq.~\ref{eq:fm_defs:rte_step2})
is used.

The method determines automatically if any part of the propagation path is
inside the cloud-box (if active). If this is the case, particle extinction is
included in \ExtMat, following the same path step averaging as applied for
pure absorbing species. For this method, scattering is purely a loss mechanism,
there is no gain by scattering into the line-of-sight

A related concern is the treatment of the surface. In standard usage of the
method, there is no signal reflected by the surface. The radiative transfer
calculations are started at the surface.

See the built-in documentation (\builtindoc{iyTransmissionStandard}) for a full
list of possible auxiliary quantities. These data include quantities that make
it possible to determine the transmission for different parts of the
propagation path. For example, the state of \builtindoc{iy} at each point of
the propagation path can be extracted, and also the transmission matrix
(Eq.~\ref{eq:rte:transmat}) for each path step is accessible.





\section{Radio link calculations}
%===================
\label{sec:rlinks}

\subsection{Practical usage}
%
This type of calculations is handled by \wsmindex{iyRadioLink}. A sensor
position must be specified, as usual. The ``sensor'' takes the place as the
receiver of the radio link. The observation angles of the receiver are not user
input (if any given they are just ignored), they are determined by the position
of the transmitter. This position is given as \wsvindex{transmitter\_pos} or
\wsvindex{rte\_pos2}, dependent on if \builtindoc{yCalc} or \builtindoc{iyCalc}
is used. Specification of receiver and transmitter properties, beside their
positions, is discussed in Section~\ref{sec:rlinks:oview}. The quantities
returned by \builtindoc{iyRadioLink} are also described in
Section~\ref{sec:rlinks:oview}.

It is allowed to use \builtindoc{iyRadioLink} together with pure geometrical
propagation paths, but this option does not give realistic results as the this
set-up misses the impact of ``defocusing'' (Sec.~\ref{sec:rlink:defoc}). With
refraction, the propagation path can not be determined in a strict analytical
manner and some search algorithm is required. ARTS contains so far just a quite
simple algorithm for this purpose, activated by applying
\wsmindex{ppathFromRtePos2} for \wsaindex{ppath\_agenda}. In short, the search
is started by determining the geometrical path. The closest distance between
this path and the receiver is converted to an estimated correction for the
``line-of-sight'' of the transmitter, the corresponding refracted path is
determined and a new correction term is obtained. The procedure is repeated
until a (stringent) hard-coded convergence criterion is fulfilled.

   
\subsection{Definitions}
%===================
\label{sec:rlinks:oview}

The radiance law is not applicable for the signal from a point source.
The power received, $p_r$, by an antenna with an effective aperture size
$A_e$, located a distance $l$ from a transmitter, with power
$p_t$ and gain $g_t$, can be expressed as \citet[e.g.][]{ippolito:satco:08}
\begin{equation}
  \label{eq:rlink:start}
  p_r(l) = t_a\frac{p_tg_t}{4\pi l^2}A_e,
\end{equation}
where $t_a$ is the transmission due to losses caused by the atmosphere. This
total atmospheric loss ($t_a$) is the product between losses due to defocusing,
$t_d$ (Sec.~\ref{sec:rlink:defoc}) and gaseous and particle extinction, $t_e$
(Sec.~\ref{sec:rlink:atmext}):
\begin{equation}
  t_a = t_d t_e.
\end{equation}
The factor
\begin{equation}
  \label{eq:rlink:fspl}
  t_f = \frac{1}{4\pi l^2}
\end{equation}
represents the pure geometrical dilution of the power, following the inverse
square law. This effect is encountered also for propagation in free space, and,
accordingly, it is denoted as the \emph{free space loss}. Please note that
other definitions of this quantity exists, see Section~\ref{sec:rlinks:free}.

With these definitions, Equation~\ref{eq:rlink:start} can be written as
\begin{equation}
  \label{eq:rlink:pr}
  p_r(l) = t_d t_e t_f p_t',
\end{equation}
where $p_t'=p_tg_tA_e$, a term discussed further in
Section~\ref{sec:rlinks:free}.

The method \wsmindex{iyRadioLink} reports $p_r$ as \builtindoc{iy}, i.e.\ $p_r$
is treated as the main quantities. All loss terms ($t_d$, $t_e$ and $t_f$) can
be obtained as auxiliary data (\builtindoc{iy\_aux}). The auxiliary variables
include also extra path delay, bending and Faraday rotation. Some of these
terms can be obtained as attenuation/rotation (per length) along the
propagation path. 

Note the distinction between ``loss'' and ``attenuation''. The first term
refers here to path-integrated transmission factors, while the second term
refers to local attenuation coefficients. That is, losses are dimensionless
values, between 0 and 1, while the unit of attenuation is $1/m$. See the
following sections for details.

The quantity returned in \builtindoc{iy} is also what ends up in
\builtindoc{y}, outputted by \builtindoc{yCalc}. For increased flexibility, the
method \FIXME{Add name when implemented} allows the user to replace the content
of \builtindoc{iy} with some of the auxiliary variables. For example, for radio
link calculations bending angle can frequently be seen as the primary
observation, and this case can be handled by \FIXME{Add name when implemented}.
The constrain for allowing this swap of variables is that the auxiliary
variable to replace $p_r$ must have the same data dimensions. In practice, this
means that the auxiliary variable is a function of frequency, possibly being a
Stokes vector for each frequency. Variables fulfilling this constrain are:
defocusing loss ($t_d$), atmospheric extinction loss ($t_e$), free space loss
($t_f$), bending angle, extra path delay, and (total) Faraday rotation.


\subsection{Free space loss and sensor characteristics}
%===================
\label{sec:rlinks:free}

It is repeated that (total) free space loss is in ARTS defined as given
above in Equation~\ref{eq:rlink:fspl}:
\begin{displaymath}
  t_f = \frac{1}{4\pi l^2}.
\end{displaymath}
It shall be noted, \underline{and stressed}, that this deviates from what
appears to be a more common (even standard?) definition of free space loss,
that is $\left(\Wvl/(4 \pi l)\right)^2$, where \Wvl\ is the wavelength of the
signal. This expression encompasses the relationship between the receiver's
effective antenna area and its gain ($A_e=g_r\Wvl^2/(4\pi)$). This later
definition was avoided to keep atmospheric and sensor effects clearly separated
in ARTS,

Hence, the definition of free space loss has consequences for how to specify
sensor characteristics. A possible choice is to treat pure multiplicative
factors such as $p_t$, $g_t$ and $A_e$ separately, and let ARTS handle the pure
radiative propagation effects. In this case, $p_t'$ (Eq.~\ref{eq:rlink:pr})
shall be set to unity (\wsmindex{MatrixUnitIntensity} handles this case). If
e.g. Faraday rotation or particle scattering is considered,
\builtindoc{stokes\-dim} must be $>1$ and also the polarisation of the
transmitted signal is of concern, and must be included in the specification of
$p_t'$ (e.g.\ $p_t'=[1,\pm1,0,0]$ when V or H is transmitted). The next step
towards a more complete treatment of the transmitter should be to include $p_t$
and $g_t$ in $p_t'$. In any case, \builtindoc{iyRadioLink} expects
\wsaindex{iy\_transmitter\_agenda} to return $p_t'$, for each frequency in
\builtindoc{f\_grid}.

So far ARTS has no dedicated support to handle characteristics of receivers in
radio link configurations. The first step here should be to consider $A_e$, but
the simplest way to achieve this is to include $A_e$ in $p_t'$ (and it is here
where the definition of free space loss comes into play, as with the standard
definition $p_t'$ should instead include $g_r$). Some functionality developed
for passive sensors could also be of use for radio links, but this has not yet
been tested practically (even less validated) and these options are not
commented further.

Setting $\Mpi=p_r$ (to be consistent in the nomenclature used elsewhere) and
taking the derivative of \(\Mpi(s)\) gives
\begin{equation}
\label{eq:fsplarts}
 \frac{\DiffD\Mpi(s)}{\DiffD s}=-\frac{2}{s}I(s).
\end{equation}
This equals the Beer-Lambert law with an attenuation coefficient of $2/s$. With
other words, the free space loss can be also treated as an ordinary extinction
term, and when ``free space attenuation'', $k_f$ is requested as an auxiliary
variable it is calculated as
\begin{equation}
 k_f=\frac{2}{s}.
\end{equation}
This extinction coefficient can be seen as non-linear, as it varies with the
distance from the transmitter. If the transmitter is placed inside the
atmosphere, $k_f$ becomes infinity for the path point corresponding to $l=0$.
The $k_f$-coefficient is not dependent on the definition differences of (total)
free space loss discussed above.


\subsection{Bending angle and extra path delay}
%
In the absence of an atmosphere a signal sent from a transmitter in the
direction towards a receiver would follow a straight line, i.e. the shortest
geometric distance between the two instruments. Moreover, the signal would
propagate with the speed of light. The geometric distance, $l_g$, between the
transmitter and receiver is
\begin{equation}
l_g\equiv\int_{\mathrm{geometric}}1\DiffD s
\end{equation}
In the presence of an atmosphere, two changes follow,
the speed of the signal is retarded and the ray path gets 
bent. The optical path length is defined as
\begin{equation}
l_o\equiv\int_{\mathrm{ray}}\Rfr(s)\DiffD s.
\end{equation}
The geometrical length of the bent ray path is
\begin{equation}
l_r\equiv\int_{\mathrm{ray}}1\DiffD s.
\end{equation}
to recall what you probably heard during our physics lessons, some quotes from
the Wikipedia entry on optical path length: \emph{Fermat's principle states
  that the path light takes between two points is the path that has the minimum
  optical path length. An electromagnetic wave that travels a path of given
  optical path length arrives with the same phase shift as if it had travelled
  a path of that physical length in a vacuum.}

The total delay, compared if there would be vacuum between transmitter and
receiver, expressed in units of length, is
\begin{equation}
d \equiv l_o-l_g \ge 0,
\end{equation}
which can be expressed also as
\begin{equation} 
d = (l_o-l_r) + (l_r-l_g) = d_{n}+d_{g},
\end{equation}
where $d_{n}$ is the along-path delay due to decreased propagation velocity,
and $d_{g}$ is delay due to deviation from geometric propagation (refraction).

The (total) extra path delay, in units of seconds, is
\begin{equation} 
\Delta t = \frac{d}{c},
\end{equation}
and is provided by \builtindoc{iyRadioLink} as an auxiliary variable. In
addition, $d_n/c$ can be obtained, then denoted as ``local path retardation''
and have the unit s/m.



\subsection{Defocusing}
\label{sec:rlink:defoc}
%
\dots



\subsection{Atmospheric extinction}
\label{sec:rlink:atmext}
%
Atmospheric absorption and scattering are handled exactly as for
\builtindoc{iyTransmissionStandard}, this including to only handle scattering
out-of-the propagation path.



\subsection{Faraday rotation}
\label{sec:rlink:farrot}
%
\dots

