\chapter{Gas absorption}
 \label{sec:absorption}


\starthistory
  2011-06-28 & Added intro and sections on abs in RT and abs
               calculation. First attempt of a complete absorption
               chapter for ARTS2. \\
  2003-03-28 & Documentation for WSM abs\_fieldCalc
               extended by Stefan Buehler after comment from Sreerekha
               T.\ R.. \\
  2003-03-10 & Lookup tables added by Stefan Buehler.\\
  2002-06-04 & Restarted for ARTS-1-1 by Stefan Buehler.
\stophistory

\startsymbolswithunits
  \Mpi         & $\frac{\mbox{W}}{\mbox{m$^2$ Hz sr}}$ & i\_rte, i\_field, \dots & Intensity\\
  \PpathLng    & m                 &                         & Path length element\rule{0ex}{1.2em}\\
  \aAbsXsec{i} & m$^2$             & xsec                    & Absorption cross section of
                                                               absorbing species $i$\\ 
  \aDen{i}     & m$^{-3}$          &                         & Number density of species $i$\\
  \aAbsCoef{i} & m$^{-1}$          & abs\_scalar\_gas        & Absorption coefficient of
                                                               absorbing species $i$\\
  \AbsCoefTot  & m$^{-1}$          &                         & Total gas absorption coefficient
 \label{symtable:absorption}     
\stopsymbolswithunits

\section{Introduction}

The absorption coefficient describes how strongly the atmosphere is
absorbing (and emitting).  Its unit (in ARTS) is m$^{-1}$.  For a
definition, see for example Equation \ref{eq:lookup:beer}.  Both gases
and particles in the atmosphere absorb, and the total absorption is
the sum of these two contributions. But this chapter is only about the
gas absorption.

When calculating radiative transfer, the local absorption coefficient
at each point in the atmosphere has to be known.  Furthermore, if one
also wants to calculate Jacobians, then the partial absorption
coefficients for different atmospheric components (different
absorption species) also have to be known.   

This chapter discusses different practical aspects of absorption in
ARTS. Section \ref{sec:absorption:abs-rt} explains how absorption is
handled inside radiative transfer calculations.  Section
\ref{sec:absorption:calculating} discusses how absorption is actually
calculated, and how the calculation is set up.  Finally, Section
\ref{sec:absorption:lookup} describes how absorption is stored in a
lookup table, and how it is extracted again.

Here in the User Guide we focus on practical aspects of absorption in
ARTS.  But absorption calculations also have a deep theoretical
background, particularly the line-by-line calculations and the
continuum models.  Some of this background is discussed in \theory,
Section \ref{T-sec:abs_theory}. 

\section{Gas absorption in radiative transfer simulations}
\label{sec:absorption:abs-rt}

The interface between the radiative transfer (RT) part of ARTS and the
absorption part of ARTS is very simple, so this will be a short
section.

The interface consists in the agenda
\wsaindex{abs\_scalar\_gas\_agenda}.  RT functions execute this agenda
whenever they need local absorption coefficients.  See the built-in
documentation for the exact input and output arguments of the agenda.
The idea is that input arguments are the local atmospheric conditions
(temperature, pressure, trace gas volume mixing ratios, etc.).  These
are all scalars.

The output of the agenda is a single variable,
\wsvindex{abs\_scalar\_gas}, a matrix with dimensions of frequency
times absorption species.  In a typical ARTS run, this agenda will be
executed many times over, for different points in the atmosphere.

Typical contents of this agenda are as follows:

\subsection{Absorption from lookup table}

\begin{code}
AgendaSet( abs_scalar_gas_agenda )
{
  Ignore(rte_doppler)
  abs_scalar_gasExtractFromLookup
}
\end{code}

This will extract absorption coefficients from a pre-calculated lookup
table.  More information on the lookup table and how to generate it
can be found in Section \ref{sec:absorption:lookup}.  See Section
\ref{sec:absorption:doppler} for an explanation of the
\artsstyle{rte\_doppler} variable, that is ignored here.
 
\subsection{On-the-fly absorption}

\begin{code}
AgendaSet( abs_scalar_gas_agenda )
{
  Ignore(rte_doppler)
  abs_scalar_gasCalcLBL
}
\end{code}

This will calculate absorption coefficients for the exact local
conditions that are given.  The setup for the calculation (which
absorption species and many other details of the calculation) has to
be done before, outside the agenda.  More information on how to set up
the absorption calculation can be found in Section
\ref{sec:absorption:calculating}.  

\subsection{On-the-fly absorption with Doppler shift}
\label{sec:absorption:doppler}

\begin{code}
AgendaSet( abs_scalar_gas_agenda )
{
  NumericScale( rte_doppler, rte_doppler, -1 )
  VectorAddScalar( f_grid, f_grid, rte_doppler )
  abs_scalar_gasCalcLBL
}
\end{code}

This agenda variant has to be used for RT simulations with Doppler
shift.  It makes use of the input variable \wsvindex{rte\_doppler},
which is ignored in the first two examples.  Doppler calculations
currently work only with on-the-fly absorption, not with lookup table
absorption. (The latter would be easy to implement upon request.) Note
that \artsstyle{rte\_doppler} and \wsvindex{f\_grid} here are local
copies of their global counterparts (this is just how agendas
work). They are manipulated here locally, but in the next call of the
agenda they will be initialized again with their original global
contents. 

\section{Calculating gas absorption}
\label{sec:absorption:calculating}

This section deals with calculating gas absorption coefficients in
ARTS.  This typically occurs in two different contexts, either
on-the-fly in the radiative transfer calculation (see Section
\ref{sec:absorption:abs-rt}), or when preparing a gas absorption
lookup table (see Section \ref{sec:absorption:lookup}).  A third and
more unusual case is that the user is only interested in the
absorption itself, for a particular atmospheric scenario, and not in
the radiative transfer simulation.

In all these cases, the same core absorption routines will be used,
although the interfaces differ. 

\subsection{Absorption species}

Absorption is additive, so the total absorption is simply the sum of
all partial absorptions.  And the partial absorption for gases that
have spectral lines can be calculated as a sum over the absorption of
each spectral line, plus some more or less empirical continuum terms.

An absorption species in ARTS is an abstract entity that has a partial
absorption coefficient associated with it, and that usually can be
associated with a volume mixing ratio of a corresponding gas. Total
absorption is the sum of the partial absorptions of all absorption
species. Absorption species are defined in the ARTS controlfile by
special `tags', which are stored in the variable
\wsvindex{abs\_species}, and set by the method \wsmindex{SpeciesSet}.

The absorption species tags describe not only the different absorbers,
but also the model that should be used to calculate the absorption.
There are two types of tags, those for explicit line-by-line
calculations, and those for continua and complete absorption models.
An example of the first kind is `H2O-18', which identifies a
particular isotope of water vapor.  An example of the second kind is
`H2O-ForeignContCKDMT100', which identifies a particular continuum
model.  Tags can be combined, if they refer to the same molecule
(different isotopes are allowed). 

This mechanism allows quite complex
absorption setups. The built-in documentation for
\wsmindex{SpeciesSet} gives a detailed explanation of the tag syntax
and some examples.  

There is no `intelligence' in ARTS that checks that the chosen tag
combination makes sense, so the user should know what she or he is
doing, or follow one of the many examples in the ARTS
\fileindex{includes} directory.


\section{The gas absorption lookup table}
\label{sec:absorption:lookup}

\subsection{Introduction}

Calculating gas absorption coefficient spectra in a line by line way
is quite an expensive thing to do. Sometimes contributions from
thousands or ten thousands of lines have to be summed up. To make
matters worse, this has to be done over and over again for each point
in the atmosphere.

Actually, the absorption coefficient depends not directly on position,
but on the atmospheric state variables:
\begin{itemize}
\item Pressure
\item Temperature
\item Trace gas concentrations
\end{itemize}

The basic idea of the lookup table is to pre-calculate absorption for
discrete combinations of these variables, and then use interpolation
to extract absorption for the actual atmospheric state.

\subsection{Lookup table concept}

The fundamental law of Beer\footnote{According to C.\ Melsheimer,
  Beer's law is: `The taller the glass, the darker the brew, the less
  the amount of light that comes through'. He might have been quoting
  someone else, there, but I do not know whom.} states that extinction
is proportional to the intensity of radiation, and to the amount of
absorbing substance:
\begin{equation}
  \label{eq:lookup:beer}
  \frac{d \Mpi}{d \PpathLng}
  =
  - \Mpi \sum_i \aAbsXsec{i} \aDen{i}
  =
  - \Mpi \sum_i \aAbsCoef{i}
  =
  - \Mpi \AbsCoefTot
\end{equation}
where the meaning of the symbols is defined in Table
\ref{symtable:absorption}. 

As one can see from the above equation, a large part of the pressure
dependence of \aAbsCoef{i} comes from \aDen{i}. (If one assumes
constant volume mixing ratio of species $i$, then \aDen{i} is
proportional to the total pressure according to the ideal gas law.) 
Therefore, the lookup table should store \AbsXsec, rather than
\AbsCoef. We then have to worry only about the dependence of \AbsXsec\
on the atmospheric state variables.

\subsubsection{Pressure dependence}

The pressure dependence is the most important dependence of
\AbsXsec. It comes from the fact that the width of the line shape
functions is governed by pressure broadening. We have to store the
\aAbsXsec{i} on some pressure grid and interpolate if we need them for
intermediate values.

\subsubsection{Temperature dependence}

This is the next effect to take into account. Both the line widths and
the line intensities depend on temperature. Of course, only certain
combinations of pressure and temperature occur in the Earth's
atmosphere. Hence, storing the \aAbsXsec{i} in a two dimensional table
as a function of pressure and temperature would waste a lot of space.
Instead, they are stored for a reference temperature and set of
temperature perturbations for each pressure level. E.g., if the set of
perturbations is $[-10,\, 0,\, +10]$, then the \aAbsXsec{i} would be stored
for three different temperatures for each pressure level:
$[T_R(p)-10\,\mbox{K},\, T_R(p),\, T_R(p)+10\,\mbox{K}]$, where
$T_R(p)$ is the reference temperature for each pressure level.

\subsubsection{Trace gas concentration dependence}

This is a second order effect. The width of the line depends not only
on total pressure, but also on the partial pressure of one or more
trace gases. In theory this is always the case, because the broadening
is different for each combination of collision partners. However, in
practice trace gas concentrations in the Earth's atmosphere are
normally so low that this can be safely neglected. An important
exception is water vapor in the lower troposphere, which can reach
quite high volume mixing ratios. Therefore, the effect of water vapor
mixing ratio on water vapor absorption (self broadening), as well as
on oxygen absorption (according to a parameterization by
\citet{pwr:93}) may not be negligible.

This is handled by storing perturbations, similar to the temperature
case. The user can select for which species perturbations should be
stored. (The so called `nonlinear species'.)

\textbf{This feature is not yet used.}
\FIXME{Update this when it works.}


\subsection{Implementation}
%-------------------------------------------------------------------------
The gas absorption lookup table is implemented by the class
\typeindex{GasAbsLookup}, which resides in the files
\fileindex{gas\_abs\_lookup.cc} and \fileindex{gas\_abs\_lookup.h}.

\subsubsection{Lookup table structure}

Below you find the actual declaration of the class GasAbsLookup with
extensive comments.

\begin{code}
//! An absorption lookup table.
/*! This class holds an absorption lookup table, as well as all
    information that is necessary to use the table to extract
    absorption. Extraction routines are implemented as member
    functions. */
struct GasAbsLookup {
public:
  // Documentation is with the implementation!
  void Adapt( const ArrayOfArrayOfSpeciesTag& current_species,
              ConstVectorView current_f_grid );

  // Documentation is with the implementation!
  void Extract( Matrix&         sga,
                            const Index&    f_index,
                            const Numeric&  p,
                            const Numeric&  T,
                ConstVectorView abs\_vmrs ) const;

    // Obsolete try for a function to extract for the entire field:
    //   void Extract( Tensor5View      sga,
    //                 const Index&     f_index,
    //                 ConstVectorView  p,
    //                 ConstTensor3View T,
    //                 ConstTensor4View abs\_vmrs ) const;

  // IO functions must be friends:
  friend void xml_read_from_stream( istream& is_xml,
                                    GasAbsLookup& gal,
                                    bifstream *pbifs );
  friend void xml_write_to_stream ( ostream& os_xml,
                                    const GasAbsLookup& gal,
                                    bofstream *pbofs );


private:

  //! The species tags for which the table is valid.
  ArrayOfArrayOfSpeciesTag species; 

  //! The species tags with non-linear treatment.
  /*! This must be inside the range of species. If nonlinear_species
    is an empty vector, it means that all species should be treated
    linearly. (No absorption for perturbed species profiles is 
    stored.) */
  ArrayOfIndex nonlinear_species; 

  //! The frequency grid [Hz].
  /*! Must be sorted in ascending order. */
  Vector    f_grid;

  //! The pressure grid for the table [Pa].
  /*! Must be sorted in decreasing order. */
  Vector    p_grid;  

  //! The reference VMR profiles.
  /*! The VMRs for all species, associated with p_grid. Dimension:
    [n_species, n_p_grid]. These VMRs are needed to scale the
    absorption coefficient to other VMRs. We are never working with
    "absorption cross-sections", always with real absorption 
    coefficients, so we have to remember the associated VMR values. 

    Physical unit: Absolute value. */
  Matrix    vmrs_ref;

  //! The reference temperature profile [K].
  /*! This is a temperature profile. The dimension must be the same as
    p_grid. */
  Vector    t_ref;

  //! The vector of temperature perturbations [K].
  /*! This can have any number of elements. Example:
    [-20,-10,0,10,20]. The actual temperatures for which absorption is
    stored are t_ref + t_pert for each level. The reference
    temperature itself should normally also be included, hence 
    t_pert should always include 0. Must be sorted in ascending order!

    The vector t_pert may be an empty vector (nelem()=0), which marks
    the special case that no interpolation in temperature should be
    done. If t_pert is not empty, you will get an error message if you
    try to extract absorption for temperatures outside the range of
    t_pert. */
  Vector    t_pert;

  //! The vector of perturbations for the VMRs of the nonlinear species.
  /*!
    These apply to all the species that have been set as
    nonlinear_species.

    Fractional units are used! Example: [0,.5,1,10,100],
    meaning from VMR 0 to 100 times the profile given in
    abs\_vmrs. The reference value should normally be included, hence
    nls_pert should always include the value 1.

    If nonlinear_species is an empty vector, it means that there are
    no nonlinear species. Then nls_pert must also be an empty vector.
  */
  Vector    nls_pert;

  //! Absorption cross sections.
  /*!
    Physical unit: m^2

    \attention We want to interpolate these beasts in pressure. To
    keep interpolation errors small it is better to store
    cross-sections, not coefficients. The absorption coefficient alpha
    is given by alpha = xsec * n, where n is the number density.

    Dimension: [ a, b, c, d ]

    Simplest case (no temperature perturbations, 
    no vmr perturbations): <br>
    a = 1 <br>
    b = n_species <br>
    c = n_f_grid <br>
    d = n_p_grid <br>

    Standard case (temperature perturbations, 
    but no vmr perturbations): <br>
    a = n_t_pert <br>
    b = n_species <br>
    c = n_f_grid <br>
    d = n_p_grid <br>

    Full case (with temperature perturbations 
    and vmr perturbations): <br>
    a = n_t_pert <br>
    b = n_species + n_nonlinear_species * ( n_nls_pert - 1 ) <br>
    c = n_f_grid <br>
    d = n_p_grid <br>

    Note that the last three dimensions are identical to the
    dimensions of abs_per_tg in ARTS-1-0. This should simplify
    computation of the lookup table with this old ARTS version.
  */
  Tensor4 xsec;
};
\end{code}

\subsubsection{Workspace variables and methods}

The lookup table itself is stored in the WSV
\wsvindex{abs\_lookup}. After loading (with \artsstyle{ReadXML}),
it is important that one calls the WSM
\wsmindex{abs\_lookupAdapt}. This will make sure that the lookup
table agrees exactly with your calculation. For example, it has to
check that the frequencies that you want to use are included in the
set of frequencies for which the table has been calculated.
\textbf{There is no interpolation in frequency!} This is on purpose,
because the gas absorption spectrum is the quantity that changes most
rapidly as a function of frequency. Frequency interpolation here would
be stupid and dangerous. The method also sorts the species in exactly
the same way that they occur in your calculation. It sets the WSV
\wsvindex{abs\_lookup\_is\_adapted} to flag that the table is now
ok.

When the table has been successfully adapted, one can extract
absorption coefficients with the WSM
\wsmindex{abs\_scalar\_gasExtractFromLookup}. This will extract
\emph{absorption coefficients}, i.e., the cross sections stored in the
table are not only interpolated to the desired atmospheric conditions,
but are also multiplied with the partial number density of the present
absorbers. 

The \artsstyle{abs\_scalar\_gasExtractFromLookup} method is meant to
be used inside the agenda \wsaindex{abs\_scalar\_gas\_agenda},
which is used in several places where absorption coefficients are
needed, both inside the scattering box and outside. 

It is also possible to calculate absorption for the entire atmospheric
field.  This is done by the method
\wsmindex{abs\_fieldCalc}, which is useful in two
different contexts:

\begin{enumerate}
\item For testing and plotting gas absorption. (For RT
  calculations, gas absorption is calculated or extracted locally,
  therefore there is no need to calculate a global field. But this
  method is handy for easy plotting of absorption vs. pressure, for
  example.)
\item Inside the scattering region, monochromatic absorption is
  pre-calculated for the entire atmospheric field.
  \FIXME{At least that's the plan, isn't it Claudia? Please remove
    this FIXME when that works.}
\end{enumerate}

Because of the different usage contexts, the method
\artsstyle{abs\_fieldCalc} can calculate absorption
either for all frequencies in the frequency grid (input variable
\wsvindex{f\_index}$<$0), or just for the frequency indicated by the
input variable \artsstyle{f\_index} (\artsstyle{f\_index}$>=$0).

The following controlfile section illustrates the use of the lookup
table together with \artsstyle{abs\_fieldCalc}. This is
not a complete controlfile. \FIXME{Eventually there should be a good
  complete example in doc/examples. For the moment you can look at the
examples in sbuehler/arts\_calc/abs\_lookup\_2/.}

\begin{code}
# Read lookup table:
ReadXML( abs_lookup, "some_table.xml" )

# Adapt lookup table:
abs_lookupAdapt

# Set agenda for extracting absorption
AgendaSet( abs_scalar_gas_agenda ){
  abs_scalar_gasExtractFromLookup
}

# Input to abs_scalar_gasExtractFromLookup{}, 
# means to calculate all frequencies.
IndexSet( f_index, -1 )

# Calculate scalar gas absorption field. (This assumes that 
# also the WSVs f_grid, atmosphere_dim, p_grid, lat_grid, 
# lon_grid, t_field, and vmr_field have been defined.)
abs_fieldCalc

# Write out the field:
WriteXML( "ascii", abs_field, "" )
\end{code}

Use the online documentation for the methods and variables mentioned
to learn more.

%%% Local Variables: 
%%% mode: latex 
%%% TeX-master: "uguide"
%%% End:

% LocalWords:  Atmosperic
