import pyarts
import numpy as np
import matplotlib.pyplot as plt
from time import time


toa = 100e3

# %% Setup workspace

ws = pyarts.Workspace()

ws.absorption_speciesSet(species=["CO2-626"])

ws.ReadCatalogData()
for key in ws.absorption_bands:
    ws.absorption_bands[key].cutoff = "ByLine"
    ws.absorption_bands[key].cutoff_value = 750e9

ws.surface_fieldSetPlanetEllipsoid(option="Earth")
ws.surface_field["t"] = 295.0

ws.atmospheric_fieldRead(
    toa=toa, basename="planets/Earth/afgl/tropical/", missing_is_zero=1
)
data = pyarts.arts.Tensor3(ws.atmospheric_field["t"].data.data)

v = np.linspace(400, 2500, 1001)
ws.frequency_grid = pyarts.arts.convert.kaycm2freq(v)

t = time()
ws.absorption_lookup_tableFromProfiles(
    pressure_profile=[101299.99999999994,90399.99999999993,85306.50619970307,80499.99999999999,75866.65934387776,71499.99999999996,67275.18115917627,63299.99999999994,59485.0401361552,55899.99999999997,52443.11203580501,49199.99999999996,46102.49450951652,43200.00000000004,40409.8997771586,37800.00000000003,35264.996809868004,32899.999999999985,30674.745312716124,28600.000000000007,26578.562790339158,24699.999999999996,22937.087870956966,21300.00000000002,19689.083269670034,18200.000000000004,16849.92581586045,15599.999999999995,14349.91289172169,13200.000000000002,12104.544601099205,11099.999999999993,10198.382224647194,9369.999999999993,8598.214931019109,7889.999999999998,7248.958545887807,6659.999999999996,6134.248120185554,5650.000000000004,5207.686626516617,4800.000000000001,4430.801281935363,4090.0000000000027,3783.516882478527,3499.9999999999995,3240.370349203926,2999.9999999999977,2776.6886753829613,2569.999999999999,2338.906821785012,2128.593432292789,1937.1913228001476,1762.9999999999993,1607.974628358201,1466.5810581075968,1337.6206079794333,1220.0000000000005,1115.2693620171112,1019.5293031590603,932.008029091767,851.9999999999997,780.4902976418091,714.9825172687787,654.9729081124403,600.0,535.2672842673808,477.5184426782954,426.00000000000017,381.1006409480746,340.9335646268388,305.00000000000006,273.53156681949076,245.30989523516584,220.00000000000009,197.4304620865445,177.17630618048383,159.0,143.13661614433772,128.85591749214768,115.99999999999999,104.7429054040664,94.57824338349323,85.4,76.9205473668404,69.28302818752144,62.40384603532062,56.207704857528036,50.62678482289073,45.60000000000001,40.94526495053561,36.76567372520962,33.01272481937836,29.6428676418546,26.61699713792532,23.900000000000002,21.336793095237734,19.048482827990995,17.00558731711434,15.181786529216215,13.553583179495977,12.1,10.89338587652387,9.807095525194194,8.829130238336438,7.948687821511073,7.156043277003803,6.442441385579078,5.8,5.171883796790518,4.611790001293845,4.112352065843476,3.667001209661015,3.2698800239753507,2.9157654333529495,2.6,2.3349402148502385,2.0969022334326457,1.8831312890196799,1.6911534525287764,1.5187470022277938,1.3639167121865081,1.22487076191946,1.1,0.9809574821612461,0.8747978016437558,0.7801267717278653,0.6957010852370434,0.620411986282706,0.5532707090604916,0.493395492466861,0.44000000000000006,0.3963946296976813,0.3571106873935498,0.32171990611466045,0.28983646147884917,0.2611127655018061,0.23523567725096803,0.2119230890354108,0.19092085091495548,0.172,0.15344174449249226,0.13688586600522837,0.1221163143965569,0.10894035065117055,0.09718603168336877,0.08669996652208564,0.07734531459645055,0.069,0.00225],
    temperature_profile=[299.7,293.7,290.69999999999993,287.7,285.7,283.7,280.34999999999997,277.0,273.65,270.3,266.95000000000005,263.6,260.3,257.0,253.65,250.3,246.95,243.6,240.3,237.0,233.55000000000004,230.1,226.85000000000002,223.6,220.3,217.0,213.65000000000003,210.3,207.00000000000003,203.7,200.35,197.0,195.9,194.8,196.8,198.8,200.75000000000003,202.7,204.7,206.7,208.7,210.7,212.64999999999998,214.6,215.79999999999998,217.0,218.10000000000002,219.2,220.29999999999998,221.4,222.8,224.2,225.6,227.0,228.32500000000002,229.65,230.97500000000002,232.3,233.65,235.0,236.35,237.7,239.04999999999998,240.4,241.75,243.1,244.9,246.7,248.5,250.33333333333334,252.16666666666666,254.0,255.79999999999998,257.59999999999997,259.4,261.2,263.0,264.8,266.40000000000003,268.0,269.6,269.8,270.0,270.2,269.06666666666666,267.9333333333333,266.79999999999995,265.66666666666663,264.5333333333333,263.4,261.68333333333334,259.96666666666664,258.25,256.5333333333333,254.81666666666666,253.1,250.25,247.4,244.55,241.7,238.85,236.0,233.55714285714288,231.11428571428573,228.67142857142858,226.22857142857143,223.7857142857143,221.34285714285716,218.9,216.45714285714286,214.0142857142857,211.57142857142858,209.12857142857143,206.6857142857143,204.24285714285716,201.8,199.67500000000004,197.55,195.42499999999998,193.3,191.175,189.05,186.925,184.79999999999998,183.8375,182.87500000000003,181.9125,180.95,179.9875,179.025,178.0625,177.1,177.08888888888887,177.07777777777778,177.06666666666666,177.05555555555554,177.04444444444445,177.03333333333333,177.0222222222222,177.01111111111112,177.0,177.91250000000002,178.825,179.73749999999998,180.65,181.5625,182.47500000000002,183.38750000000002,184.3,400,],
    vmr_profiles={"CO2": [0.0003302605,0.0003302407,0.0003302288,0.0003302169,0.0003302544,0.0003302919,0.00033024155,0.0003301912,0.000330233,0.0003302748,0.00033028455,0.0003302943,0.00033020520000000004,0.0003301161,0.0003302186,0.0003303211,0.0003302629,0.0003302047,0.0003302599,0.0003303151,0.0003302453,0.0003301755,0.00033017565,0.0003301758,0.00033020369999999996,0.0003302316,0.0003302122,0.0003301928,0.0003302234,0.000330254,0.0003302861,0.0003303182,0.0003302095,0.0003301008,0.00033019255,0.0003302843,0.0003302264,0.0003301685,0.0003301815,0.0003301945,0.00033019065,0.0003301868,0.00033015830000000004,0.0003301298,0.00033019385,0.0003302579,0.00033027465000000003,0.0003302914,0.00033024045000000003,0.0003301895,0.000330219025,0.00033024854999999997,0.000330278075,0.0003303076,0.00033028095,0.0003302543,0.00033022765,0.000330201,0.00033020925,0.0003302175,0.00033022575,0.000330234,0.00033024495,0.0003302559,0.00033026685000000003,0.0003302778,0.00033031136666666666,0.00033034493333333336,0.0003303785,0.0003303292666666667,0.00033028003333333334,0.0003302308,0.0003302589666666667,0.0003302871333333333,0.0003303153,0.00033027623333333335,0.0003302371666666667,0.0003301981,0.0003301986,0.00033019909999999997,0.0003301996,0.00033021786666666665,0.00033023613333333333,0.0003302544,0.00033025526666666667,0.0003302561333333333,0.00033025700000000003,0.0003302578666666667,0.00033025873333333334,0.0003302596,0.00033026648333333333,0.00033027336666666666,0.00033028025,0.0003302871333333333,0.00033029401666666666,0.0003303009,0.0003302764,0.00033025190000000003,0.0003302274,0.0003302029,0.0003301784,0.0003301539,0.0003301556142857143,0.00033015732857142856,0.0003301590428571428,0.0003301607571428571,0.0003301624714285714,0.00033016418571428567,0.0003301659,0.0003301819285714286,0.0003301979571428571,0.00033021398571428574,0.0003302300142857143,0.0003302460428571429,0.00033026207142857145,0.0003302781,0.00033002083750000006,0.000329763575,0.0003295063125,0.00032924905,0.0003289917875,0.000328734525,0.0003284772625,0.00032821999999999994,0.00032722602499999997,0.00032623205,0.00032523807499999996,0.0003242441,0.000323250125,0.00032225615,0.000321262175,0.0003202682,0.0003191460222222222,0.0003180238444444444,0.00031690166666666666,0.00031577948888888887,0.0003146573111111111,0.0003135351333333333,0.00031241295555555556,0.00031129077777777777,0.0003101686,0.000305077,0.0002999854,0.00029489379999999996,0.0002898022,0.00028471059999999996,0.000279619,0.00027452739999999997,0.0002694358,3.5e-05,]},
    temperature_perturbation=np.linspace(-40, 40)
)
print(time() - t, "s to train the LUT")

ws.spectral_radiance_unit = "Tb"
ws.spectral_radiance_space_agendaSet(option="UniformCosmicBackground")
ws.spectral_radiance_surface_agendaSet(option="Blackbody")

pos = [100e3, 0, 0]
los = [180.0, 0.0]
ws.ray_pathGeometric(pos=pos, los=los, max_step=1000.0)

# %% Checks and settings for LBL
for temperature_offset in np.linspace(-20, 20, 5):
    ws.atmospheric_field["t"].data.data = data + temperature_offset

    t = time()
    ws.propagation_matrix_agendaAuto(use_absorption_lookup_table=0)
    ws.spectral_radianceClearskyEmission()
    ws.spectral_radianceApplyUnitFromSpectralRadiance()
    lbl = ws.spectral_radiance[:, 0] * 1.0
    print(time() - t, "s to compute the LBL spectral radiance")

    t = time()
    ws.propagation_matrix_agendaAuto(f_interp_order=0, p_interp_order=5, t_interp_order=7,use_absorption_lookup_table=1)
    ws.spectral_radianceClearskyEmission()
    ws.spectral_radianceApplyUnitFromSpectralRadiance()
    lut = ws.spectral_radiance[:, 0] * 1.0
    print(time() - t, "s to compute the LUT spectral radiance")

    plt.figure()
    plt.plot(v, lbl-lut, label="LBL - LUT")
    plt.legend()
    plt.xlabel("Frequency [cm$^{-1}$]")
    plt.ylabel("Radiance difference [K]")

    assert np.allclose(lbl, lut, atol=0.1)
