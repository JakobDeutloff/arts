################################################################################
#                                                                              #
# DO NOT MODIFY this file (unless you are sure what you are doing).            #
# This is only a helper file!                                                  #
#                                                                              #
################################################################################
#                                                                              #
# This file interpolates raw 1D basic atmospheric data (z_field_raw,           #
# t_field_raw, vmr_field_raw) to the calculation grids (p_grid) for 1D         #
# atmosphere output.                                                           #
#                                                                              #
# This file expects the following input parameters:                            #
#   poptmp             (String)        Name of temporary file containing the   #
#                                       list of single scattering data files.  #
#   pndtmp             (String)        Name of temporary file containing       #
#                                       pnd_field_raw.                         #
#   tmpformat          (String)        File format of temporary files.         #
#   atmosphere_dim     as the WSV                                              #
#   f_grid             as the WSV                                              #
#   p_grid             as the WSV                                              #
#                                                                              #
# Output:                                                                      #
#   pnd_field          as the WSV                                              #
#   scat_data    as the WSV                                              #
#   cloudbox_on        as the WSV                                              #
#   cloudbox_limits    as the WSV                                              #
#                                                                              #
################################################################################

Arts2 {

# forth, we get the pnd field and and single scattering data in their respective
#  WSVs pnd_field_raw and scat_data.
ReadXML( out=ssdfiles, filename=poptmp )
ParticleTypeAddAll( scat_data_files=ssdfiles, pnd_fieldarray_file=pndtmp )
scat_dataCheck

Extract( pmax_cb, p_grid, 0 )
nelemGet( itmp, p_grid )
IndexStepDown( itmp, itmp )
Extract( pmin_cb, p_grid, itmp )
cloudboxSetManually( p1=pmax, p2=pmin,
                     lat1=0, lat2=0, lon1=0, lon2=0 )
pnd_fieldCalcFrompnd_field_raw( zeropadding=1 )

# cloudboxSetAutomatically typically works on scat_Species_fields. To make it
#  work with pnd_field, we need to pass some empty dummy fields in instead.
Tensor4Create( t4tmp )
Touch( t4tmp )
cloudboxSetAutomatically( scat_species_mass_density_field=pnd_field,
                          scat_species_mass_flux_field=t4tmp,
                          scat_species_number_density_field=t4tmp )
pnd_fieldCalcFrompnd_field_raw( zeropadding=1 )

# finally, we clean up the dummy files (not completely, though, as deleting
#  files from within ARTS is not possible. instead, we write an empty variable
#  into them.)
Delete( strtmp )
Touch( strtmp )
WriteXML( output_file_format=tmpformat, in=strtmp, filename=pndtmp )
WriteXML( output_file_format=tmpformat, in=strtmp, filename=poptmp )

}
